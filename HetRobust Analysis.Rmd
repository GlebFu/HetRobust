---
title: "HetRobust Analysis"
author: "Gleb Furman"
date: "October 8, 2015"
output: html_document
---

```{r, cache = F, echo = F, warning = F, results = "hide", message = F}
library(plyr)
library(dplyr)
library(ggplot2)
library(reshape2)

rm(list = ls())

results <- read.csv("20150929.csv")

results <- select(results, n, B, Estruct, Edist, HC:p10)
levels(results$B) <- c("Model 2", "Model 1")


```

```{r, cache = T, echo = F, warning = F, results = "asis", fig.width = 15, fig.height = 15}

filter(results, criterion == "size") %>%
  select(n, Estruct, Edist, HC, coef, test, p05) %>%
  group_by(test, HC, n) %>%
  mutate(alpha = ifelse(quantile(p05, prob = .75) <= .05427,.5,.4)) %>%
  ggplot(aes(y = p05,
             x = test,
             fill = test,
             alpha = alpha)) +
  geom_boxplot() +
  facet_grid(n ~ HC) +
  coord_cartesian(ylim = c(.000, .075)) + 
  geom_hline(aes(yintercept = .05427), linetype = "dashed") + 
  geom_hline(aes(yintercept = .05)) +
  theme_bw() + theme(legend.position = "bottom") + 
  scale_alpha(guide = 'none') +
  labs(title = "Performance of Sandwich Estimators with Adjustment",
       y = "Size",
       x = "Adjustments")
```


```{r, cache = T, echo = F, warning = F, results = "asis", fig.width = 15, fig.height = 15, eval = F}
edm <- function() {
  
  # Distributions used in generating data
  b1 <- runif(10000, 0, 1)
  b2 <- rnorm(10000, 0, 1)
  b3 <- rchisq(10000, 1)
  b4 <- rnorm(10000, 0, 1)
  b5 <- runif(10000, 0, 1)
  
  # Four independant variables based on distributions
  x0 <- 1
  x1 <- 1 + b1
  x2 <- 3 * b1 + .6 * b2
  x3 <- 2 * b1 + .6 * b3
  x4 <- .1 * x1 + .9 * x3 - .8 * b4 + 4 * b5
  x2[x2 < -2.5] <- -2.5
  x4[x4 < -2.5] <- -2.5
  
  # One dummy variable created by splitting x2
  xD <- ifelse(x2 > 1.6, 1, 0)
  
  # Three types of homoscedastistic error distributions:
  
  En = rnorm(10000, 0, 1)
  Ech = (rchisq(10000, 5) - 5) / sqrt(10)
  Et = rt(10000, 5)

  # Seven types of error structures
  
  E0 = 1
  E1 = sqrt(x1)
  E2 = sqrt(x3 + 1.6)
  E3 = sqrt(x3) * sqrt(x4 + 2.5)
  E4 = sqrt(x1) * sqrt(x2 + 2.5) * sqrt(x3)
  E5 = ifelse(xD == 1, 1.5, 1)
  E6 = ifelse(xD == 1, 4, 1)
  
  X <- cbind(x0, x1, x2, x3, x4, xD)
  
  B = c(1, 1, 1, 1, 0, 0)
  
  Y <- as.vector(X %*% B)
  
  ESs <- cbind(E0, E1, E2, E3, E4, E5, E6)
  
  EnES <- data.frame(dist = "En", Y = Y, En * ESs)
  EchES <- data.frame(dist = "Ech", Y = Y, Ech * ESs)
  EtES <- data.frame(dist = "Et", Y = Y, Et * ESs)

  EDESs <- rbind(En = EnES, Ech = EchES, Et = EtES)
  


 
  return(EDESs)
}

EDists <-  edm()

backup <- EDists
EDists <- backup

EDists <-  melt(EDists, id.vars = c("dist", "Y"), variable.name = "EStructs", value.name = "x")

ggplot(EDists, aes(x = Y,
                   y = x)) +
  geom_point() +
  facet_grid(EStructs ~ dist)

ggplot(EDists, aes(x = x,
                   y = Y)) +
  geom_point() +
  facet_grid(EStructs ~ dist)

```

```{r, cache = T, echo = F, warning = F, results = "asis", fig.width = 15, fig.height = 15}

filter(results, test == "naive", criterion == "size") %>%
  select(n, Estruct, Edist, HC, coef, p05) %>%
  group_by(HC, Estruct, n) %>%
  mutate(alpha = ifelse(quantile(p05, prob = .75) <= .05427,.5,.4)) %>%
  ggplot(aes(x = HC,
             y = p05,
             fill = HC,
             alpha = alpha)) +
  geom_boxplot() +
  facet_grid(n ~ Estruct) +
  geom_hline(aes(yintercept = .05427), linetype = "dashed") + 
  geom_hline(aes(yintercept = .05)) +
  ylim(.025, .075) +
  theme_bw() + theme(legend.position = "bottom") + 
  scale_alpha(guide = 'none') +
  labs(title = "Performance of Naive Sandwich Estimators by Error Structure",
       y = "Size",
       x = "Sandwich Estimators")

```

```{r, cache = T, echo = F, warning = F, results = "asis", fig.width = 15, fig.height = 15}

filter(results, test == "edgeKC", criterion == "size") %>%
  select(n, Estruct, Edist, HC, coef, p05) %>%
  group_by(HC, Estruct, n) %>%
  mutate(alpha = ifelse(quantile(p05, prob = .75) <= .05427,.5,.4)) %>%
  ggplot(aes(x = HC,
             y = p05,
             fill = HC,
             alpha = alpha)) +
  geom_boxplot() +
  facet_grid(n ~ Estruct) +
  geom_hline(aes(yintercept = .05427), linetype = "dashed") + 
  geom_hline(aes(yintercept = .05)) +
  ylim(.025, .075) +
  theme_bw() + theme(legend.position = "bottom") + 
  scale_alpha(guide = 'none') +
  labs(title = "Performance of EdgeKC Sandwich Estimators by Error Structure",
       y = "Size",
       x = "Sandwich Estimators")

```

```{r, cache = T, echo = F, warning = F, results = "asis", fig.width = 15, fig.height = 15}

filter(results, test == "saddle_V1", criterion == "size") %>%
  select(n, Estruct, Edist, HC, coef, p05) %>%
  group_by(HC, Estruct, n) %>%
  mutate(alpha = ifelse(quantile(p05, prob = .75) <= .05427,.5,.4)) %>%
  ggplot(aes(x = HC,
             y = p05,
             fill = HC,
             alpha = alpha)) +
  geom_boxplot() +
  facet_grid(n ~ Estruct) +
  geom_hline(aes(yintercept = .05427), linetype = "dashed") + 
  geom_hline(aes(yintercept = .05)) +
  ylim(.025, .075) +
  theme_bw() + theme(legend.position = "bottom") + 
  scale_alpha(guide = 'none') +
  labs(title = "Performance of Model-Based Saddlepoint Sandwich Estimators by Error Structure",
       y = "Size",
       x = "Sandwich Estimators")

```

```{r, cache = T, echo = F, warning = F, results = "asis", fig.width = 15, fig.height = 15}

filter(results, test == "saddle_V2", criterion == "size") %>%
  select(n, Estruct, Edist, HC, coef, p05) %>%
  group_by(HC, Estruct, n) %>%
  mutate(alpha = ifelse(quantile(p05, prob = .75) <= .05427,.5,.4)) %>%
  ggplot(aes(x = HC,
             y = p05,
             fill = HC,
             alpha = alpha)) +
  geom_boxplot() +
  facet_grid(n ~ Estruct) +
  geom_hline(aes(yintercept = .05427), linetype = "dashed") + 
  geom_hline(aes(yintercept = .05)) +
  ylim(.025, .075) +
  theme_bw() + theme(legend.position = "bottom") + 
  scale_alpha(guide = 'none') +
  labs(title = "Performance of Empirical-Based Saddlepoint Sandwich Estimators by Error Structure",
       y = "Size",
       x = "Sandwich Estimators")

```

```{r, cache = T, echo = F, warning = F, results = "asis", fig.width = 15, fig.height = 15}

filter(results, test == "Satt", criterion == "size") %>%
  select(n, Estruct, Edist, HC, coef, p05) %>%
  group_by(HC, Estruct, n) %>%
  mutate(alpha = ifelse(quantile(p05, prob = .75) <= .05427,.5,.4)) %>%
  ggplot(aes(x = HC,
             y = p05,
             fill = HC,
             alpha = alpha)) +
  geom_boxplot() +
  facet_grid(n ~ Estruct) +
  geom_hline(aes(yintercept = .05427), linetype = "dashed") + 
  geom_hline(aes(yintercept = .05)) +
  ylim(.025, .075) +
  theme_bw() + theme(legend.position = "bottom") + 
  scale_alpha(guide = 'none') +
  labs(title = "Performance of Satterthwaite Sandwich Estimators by Error Structure",
       y = "Size",
       x = "Sandwich Estimators")

```

